name: Dependabot Auto-Merge

# NOTE: Using pull_request_target instead of pull_request is intentional.
# This allows the workflow to run with the repository's full permissions,
# which is necessary for auto-merge operations. However, this means we MUST
# verify the PR source is trustworthy (only dependabot[bot]) before taking actions.
# See: https://github.blog/changelog/2021-02-19-github-actions-workflows-triggered-by-dependabot-prs-run-with-read-only-permissions/

on:
  pull_request_target:
    types:
      - opened
      - synchronize
      - reopened

# Prevent concurrent runs for the same PR number to avoid race conditions
concurrency:
  group: dependabot-auto-merge-${{ github.event.pull_request.number }}
  cancel-in-progress: true

jobs:
  # Job 1: Auto-Approve the Dependabot PR
  auto-approve:
    name: Auto-Approve Dependabot PR
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    outputs:
      should_auto_merge: ${{ steps.check-dependabot.outputs.should_auto_merge }}

    steps:
      - name: Verify PR is from dependabot
        id: check-dependabot
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          PR_AUTHOR="${{ github.event.pull_request.user.login }}"

          # Check if PR is from dependabot
          if [[ "$PR_AUTHOR" != "dependabot[bot]" ]]; then
            echo "âœ— PR is from $PR_AUTHOR, not dependabot - skipping"
            echo "approved=false" >> $GITHUB_OUTPUT
            echo "should_auto_merge=false" >> $GITHUB_OUTPUT
            exit 0
          fi

          echo "âœ“ PR is from dependabot[bot]"
          echo "approved=true" >> $GITHUB_OUTPUT

          # Check if this is a Docker ubuntu base image update
          # These PRs modify the Dockerfile and trigger update-version.yml which creates
          # a new commit. We'll approve but NOT auto-merge to avoid race conditions.
          if echo "$PR_TITLE" | grep -qiE "bump ubuntu from.*jammy"; then
            echo "âš  This is a Ubuntu base image update"
            echo "âš  Auto-merge will be skipped to avoid race with update-version.yml"
            echo "âš  Please merge manually after tests pass"
            echo "should_auto_merge=false" >> $GITHUB_OUTPUT
          else
            echo "âœ“ This PR can be auto-merged"
            echo "should_auto_merge=true" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Approve PR with GitHub CLI
        if: steps.check-dependabot.outputs.approved == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Approving PR #$PR_NUMBER..."
          gh pr review "$PR_NUMBER" --approve \
            --body "Auto-approved by dependabot-auto-merge workflow"
        shell: bash

      - name: Add approval summary
        if: steps.check-dependabot.outputs.approved == 'true'
        run: echo "âœ… PR Auto-Approved" >> $GITHUB_STEP_SUMMARY

      - name: Comment on Ubuntu base image PRs
        if: steps.check-dependabot.outputs.approved == 'true' && steps.check-dependabot.outputs.should_auto_merge == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR_NUMBER" --body "ðŸ‘‹ This Ubuntu base image update has been auto-approved!

          âš ï¸ **Auto-merge is disabled** for this PR to avoid race conditions with the \`update-version.yml\` workflow.

          **Next steps:**
          1. Wait for all CI checks to pass âœ…
          2. Manually merge this PR
          3. The \`update-version.yml\` workflow will automatically:
             - Update version references in README.md
             - Create a version tag (e.g., \`v3.7.4-YYYYMMDD\`)
             - Trigger the release build

          See [CLAUDE.md](https://github.com/mountaintopsolutions/docker-apt-cacher-ng/blob/master/CLAUDE.md) for more details."
        shell: bash

  # Job 2: Wait for CI checks to pass
  wait-for-tests:
    name: Wait for CI Tests
    needs: auto-approve
    runs-on: ubuntu-latest
    permissions:
      checks: read
      actions: read
    timeout-minutes: 30

    steps:
      - name: Get commit SHA
        id: get-sha
        run: |
          SHA="${{ github.event.pull_request.head.sha }}"
          echo "commit_sha=$SHA" >> $GITHUB_OUTPUT
          echo "Waiting for checks on commit: $SHA"
        shell: bash

      - name: Wait for build workflow to complete
        id: wait-workflow
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ steps.get-sha.outputs.commit_sha }}
          REPO: ${{ github.repository }}
        run: |
          set -e

          # The actual workflow name from build.yml line 1
          WORKFLOW_NAME="Build and Publish"
          MAX_ATTEMPTS=60  # 30 minutes with 30-second intervals
          ATTEMPT=0
          WORKFLOW_COMPLETED=false
          WORKFLOW_PASSED=false

          echo "Polling for workflow completion (looking for: $WORKFLOW_NAME)..."

          while [[ $ATTEMPT -lt $MAX_ATTEMPTS ]]; do
            # Get workflow runs for this commit
            WORKFLOW_RUNS=$(gh api \
              -H "Accept: application/vnd.github.v3+json" \
              "repos/$REPO/actions/runs" \
              -f "head_sha=$COMMIT_SHA" \
              --jq "[.workflow_runs[] | select(.name == \"$WORKFLOW_NAME\")] | .[0] // {}" 2>/dev/null || echo "{}")

            # Check if we found a workflow run
            WORKFLOW_ID=$(echo "$WORKFLOW_RUNS" | jq -r '.id // empty')

            if [[ -n "$WORKFLOW_ID" && "$WORKFLOW_ID" != "null" ]]; then
              STATUS=$(echo "$WORKFLOW_RUNS" | jq -r '.status')
              CONCLUSION=$(echo "$WORKFLOW_RUNS" | jq -r '.conclusion')

              echo "Workflow Run ID: $WORKFLOW_ID"
              echo "Status: $STATUS"
              echo "Conclusion: $CONCLUSION"

              if [[ "$STATUS" == "completed" ]]; then
                WORKFLOW_COMPLETED=true
                if [[ "$CONCLUSION" == "success" ]]; then
                  WORKFLOW_PASSED=true
                  echo "âœ“ Workflow completed successfully"
                else
                  echo "âœ— Workflow failed with conclusion: $CONCLUSION"
                fi
                break
              fi
            fi

            ATTEMPT=$((ATTEMPT + 1))
            REMAINING_MINUTES=$(((MAX_ATTEMPTS - ATTEMPT) * 30 / 60))
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS (${REMAINING_MINUTES}m remaining)... workflow not completed yet, waiting 30s"
            sleep 30
          done

          if [[ $WORKFLOW_COMPLETED == false ]]; then
            echo "âœ— Workflow did not complete within 30 minutes"
            echo "workflow_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi

          if [[ $WORKFLOW_PASSED == true ]]; then
            echo "workflow_passed=true" >> $GITHUB_OUTPUT
          else
            echo "workflow_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: Check status checks and check runs
        id: check-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          COMMIT_SHA: ${{ steps.get-sha.outputs.commit_sha }}
          REPO: ${{ github.repository }}
        run: |
          echo "Checking status checks and check runs for commit: $COMMIT_SHA"

          # Check GitHub Actions check runs (this is what Actions create)
          CHECK_RUNS_FAILED=$(gh api \
            "repos/$REPO/commits/$COMMIT_SHA/check-runs" \
            --jq '[.check_runs[] | select(.conclusion == "failure" or .conclusion == "cancelled")] | length' 2>/dev/null || echo "0")

          CHECK_RUNS_TOTAL=$(gh api \
            "repos/$REPO/commits/$COMMIT_SHA/check-runs" \
            --jq '.check_runs | length' 2>/dev/null || echo "0")

          echo "Check runs: $CHECK_RUNS_TOTAL total, $CHECK_RUNS_FAILED failed/cancelled"

          # Also check combined status (for any traditional commit statuses)
          COMBINED_STATUS=$(gh api \
            "repos/$REPO/commits/$COMMIT_SHA/status" \
            --jq '.state' 2>/dev/null || echo "unknown")

          echo "Combined status: $COMBINED_STATUS"

          # Pass only if no check runs failed AND combined status is success or pending
          if [[ $CHECK_RUNS_FAILED -eq 0 ]] && [[ "$COMBINED_STATUS" != "failure" ]]; then
            echo "âœ“ All status checks and check runs passed"
            echo "checks_passed=true" >> $GITHUB_OUTPUT
          else
            echo "âœ— Some checks failed (check runs failed: $CHECK_RUNS_FAILED, combined status: $COMBINED_STATUS)"
            echo "checks_passed=false" >> $GITHUB_OUTPUT
            exit 1
          fi
        shell: bash

      - name: Add test summary
        if: steps.check-status.outputs.checks_passed == 'true'
        run: echo "âœ… All CI Tests Passed" >> $GITHUB_STEP_SUMMARY

      - name: Report test failure
        if: failure()
        run: echo "âŒ CI Tests Failed or Timeout" >> $GITHUB_STEP_SUMMARY

  # Job 3: Auto-merge the PR
  auto-merge:
    name: Auto-Merge PR
    needs: [auto-approve, wait-for-tests]
    runs-on: ubuntu-latest
    permissions:
      pull-requests: write
      contents: write
    # Only run if tests passed AND auto-merge is allowed (not a Ubuntu base image update)
    if: success() && needs.auto-approve.outputs.should_auto_merge == 'true'

    steps:
      - name: Check PR is still open
        id: check-pr-status
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          PR_STATE=$(gh pr view "$PR_NUMBER" --json state --jq '.state')
          echo "PR state: $PR_STATE"

          if [[ "$PR_STATE" == "OPEN" ]]; then
            echo "âœ“ PR is still open"
            echo "is_open=true" >> $GITHUB_OUTPUT
          else
            echo "âœ— PR is already closed (state: $PR_STATE)"
            echo "is_open=false" >> $GITHUB_OUTPUT
          fi
        shell: bash

      - name: Enable auto-merge
        if: steps.check-pr-status.outputs.is_open == 'true'
        id: enable-merge
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          echo "Enabling auto-merge for PR #$PR_NUMBER with merge strategy (creates merge commit)..."

          # Enable auto-merge with merge commit strategy
          if ! OUTPUT=$(gh pr merge "$PR_NUMBER" --auto --merge 2>&1); then
            EXIT_CODE=$?
            echo "Auto-merge command returned exit code: $EXIT_CODE"

            # Check if this is an expected error (auto-merge already enabled)
            if echo "$OUTPUT" | grep -qiE "(auto-merge|already).*enabled"; then
              echo "âš  Auto-merge already enabled, continuing"
              exit 0
            # Check if repository doesn't have auto-merge enabled
            elif echo "$OUTPUT" | grep -qiE "auto.?merge.*not.*enabled|feature.*not.*enabled"; then
              echo "âŒ Repository doesn't have auto-merge enabled!"
              echo "Please enable auto-merge in repository settings:"
              echo "  Settings â†’ General â†’ Pull Requests â†’ Allow auto-merge"
              exit 1
            # Check for merge conflicts
            elif echo "$OUTPUT" | grep -qiE "conflict|mergeable"; then
              echo "âŒ Merge conflict detected: $OUTPUT"
              exit 1
            # Check for branch protection violations
            elif echo "$OUTPUT" | grep -qiE "protection|required|review"; then
              echo "âŒ Branch protection requirements not met: $OUTPUT"
              exit 1
            else
              echo "âŒ Failed to enable auto-merge: $OUTPUT"
              exit 1
            fi
          fi

          echo "âœ“ Auto-merge enabled successfully"
          echo "merge_enabled=true" >> $GITHUB_OUTPUT
        shell: bash

      - name: Add merge comment
        if: steps.check-pr-status.outputs.is_open == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
        run: |
          gh pr comment "$PR_NUMBER" \
            --body "âœ… Auto-merging after successful CI tests. All required checks have passed."
        shell: bash

      - name: Add merge summary
        if: steps.check-pr-status.outputs.is_open == 'true'
        run: echo "âœ… Auto-Merge Enabled" >> $GITHUB_STEP_SUMMARY

      - name: Report merge skipped
        if: steps.check-pr-status.outputs.is_open == 'false'
        run: echo "âš  PR already closed, merge skipped" >> $GITHUB_STEP_SUMMARY

      - name: Add final summary
        run: |
          cat >> $GITHUB_STEP_SUMMARY << 'EOF'

          ## Dependabot Auto-Merge Workflow Complete

          - âœ… Dependabot PR auto-approved
          - âœ… CI tests verified to pass
          - âœ… Auto-merge enabled

          The PR will automatically merge once all branch protection rules are satisfied.
          EOF
