name: Build and Publish

on:
  push:
    branches:
      - master
    tags:
      - 'v*.*.*'
  pull_request:
    branches:
      - master
  workflow_dispatch:
    inputs:
      acng_version:
        description: 'apt-cacher-ng version'
        required: false
        type: string
        default: '3.7.4'

jobs:

  build-test-image:
    name: Build Image for Testing & Scan Image
    runs-on: ubuntu-latest

    permissions:
      packages: write
      security-events: write
      contents: read

    steps:

      - name: Checkout git repo
        uses: actions/checkout@v5

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build Test Image
        uses: docker/build-push-action@v6
        with:
          context: .
          load: true
          tags: apt-cacher-ng:test
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64  # Single platform for testing

      - name: Run Trivy for HIGH,CRITICAL CVEs and report (blocking)
        uses: aquasecurity/trivy-action@master
        with:
          image-ref: apt-cacher-ng:test
          exit-code: 0
          ignore-unfixed: true
          vuln-type: 'os,library'
          severity: 'HIGH,CRITICAL'
          format: 'sarif'
          output: 'results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
          category: results

  test-integration:
      name: Integration tests in Docker Compose
      needs: [build-test-image]
      runs-on: ubuntu-latest

      steps:
        - name: Checkout git repo
          uses: actions/checkout@v5

        - name: Set up Docker Buildx
          uses: docker/setup-buildx-action@v3

        - name: Build Test Image
          uses: docker/build-push-action@v6
          with:
            context: .
            load: true
            tags: apt-cacher-ng:test
            cache-from: type=gha
            platforms: linux/amd64

        - name: Create test docker-compose file
          run: |
            cat > docker-compose.test.yml << 'EOF'
            services:
              apt-cacher-ng:
                image: apt-cacher-ng:test
                init: true
                ports:
                  - "3142:3142"
                volumes:
                  - apt-cache:/var/cache/apt-cacher-ng
                  - apt-logs:/var/log/apt-cacher-ng
                healthcheck:
                  test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:3142/acng-report.html"]
                  interval: 10s
                  timeout: 5s
                  retries: 3
                  start_period: 30s

              test-client:
                image: ubuntu:jammy
                depends_on:
                  apt-cacher-ng:
                    condition: service_healthy
                volumes:
                  - apt-logs:/test-logs:ro
                command: sleep 300
                environment:
                  - http_proxy=http://apt-cacher-ng:3142
                  - https_proxy=http://apt-cacher-ng:3142

            volumes:
              apt-cache:
              apt-logs:
            EOF

        - name: Start services
          run: docker compose -f docker-compose.test.yml up -d

        - name: Wait for apt-cacher-ng to be healthy
          run: |
            echo "Waiting for apt-cacher-ng to be healthy..."
            timeout 60 bash -c 'until docker compose -f docker-compose.test.yml ps apt-cacher-ng | grep -q "healthy"; do sleep 2; done'

        - name: Test 1 - Service is accessible
          run: |
            echo "Testing if apt-cacher-ng service is accessible..."
            curl -f "http://localhost:3142/acng-report.html" | grep -i "apt-cacher" || exit 1
            echo "✓ Service is accessible"

        - name: Test 2 - Package download through cache
          run: |
            echo "Testing package download through cache..."
            docker compose -f docker-compose.test.yml exec --user root test-client bash -c "
              apt-get update &&
              apt-get download curl -y
            " || exit 1
            echo "✓ Package download successful"

        - name: Test 3 - Log files are created and tailing works
          run: |
            echo "Testing log file creation and tailing..."

            # Check if log files are created
            docker compose -f docker-compose.test.yml exec test-client bash -c "
              ls -la /test-logs/ | grep -E '(apt-cacher\.(log|err|dbg))'
            " || exit 1
            echo "✓ Log files are created"

            # Check if logs contain activity
            sleep 5
            docker compose -f docker-compose.test.yml logs apt-cacher-ng | grep -E "(apt-cacher\.(log|err|dbg)|==>.*/var/log)" || exit 1
            echo "✓ Log tailing is working"

        - name: Test 4 - Cache functionality verification
          run: |
            echo "Testing cache functionality..."

            # Download same package again to test caching
            docker compose -f docker-compose.test.yml exec --user root test-client bash -c "
              apt-get download curl -y
            "

            # Check cache directory has content
            docker compose -f docker-compose.test.yml exec apt-cacher-ng bash -c "
              find /var/cache/apt-cacher-ng -name '*.deb' | head -1
            " || exit 1
            echo "✓ Cache functionality verified"

        - name: Test 5 - Service responds to management interface
          run: |
            echo "Testing management interface..."
            curl -f "http://localhost:3142/acng-report.html" | grep -i "apt-cacher" || exit 1
            echo "✓ Management interface is working"

        - name: Test 6 - Entrypoint log aggregation
          run: |
            echo "Testing entrypoint log aggregation..."

            # Trigger some activity to generate logs
            docker compose -f docker-compose.test.yml exec --user root test-client bash -c "
              apt-get update > /dev/null 2>&1
            "

            sleep 5

            # Get container logs
            logs=$(docker compose -f docker-compose.test.yml logs apt-cacher-ng)

            # Check for log aggregation headers (tail -f output format)
            echo "Checking for log aggregation headers..."
            if echo "$logs" | grep -E "==>.*/var/log/apt-cacher-ng" > /dev/null; then
              echo "✓ Found log aggregation headers"
            else
              echo "✗ No log aggregation headers found"
              exit 1
            fi

            # Check for actual successful cache activity (InRelease files indicate successful apt operations)
            echo "Checking for successful cache activity..."
            if echo "$logs" | grep -E "^apt-cacher-ng-1.*[0-9]{10}\|[IO]\|.*InRelease" > /dev/null; then
              echo "✓ Found successful cache activity with InRelease files"
            else
              echo "✗ No successful cache activity found (no InRelease file entries)"
              echo "Available logs:"
              echo "$logs"
              exit 1
            fi

            echo "✓ Entrypoint log aggregation is working correctly"

        - name: Show logs on failure
          if: failure()
          run: |
            echo "=== apt-cacher-ng service logs ==="
            docker compose -f docker-compose.test.yml logs apt-cacher-ng
            echo "=== apt-cacher-ng container inspect ==="
            docker compose -f docker-compose.test.yml ps
            echo "=== Cache directory contents ==="
            docker compose -f docker-compose.test.yml exec apt-cacher-ng ls -la /var/cache/apt-cacher-ng/ || true
            echo "=== Log directory contents ==="
            docker compose -f docker-compose.test.yml exec apt-cacher-ng ls -la /var/log/apt-cacher-ng/ || true

        - name: Cleanup
          if: always()
          run: docker compose -f docker-compose.test.yml down -v

  build-and-push-docker-image:
    name: Build and Push Docker Image
    needs: [test-integration]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v5

      - name: Docker meta
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: |
            ghcr.io/mountaintopsolutions/apt-cacher-ng
          tags: |
            type=ref,event=tag
            type=raw,value=latest,enable=${{ github.ref_type == 'tag' }}
            type=sha,prefix=sha-

          # Tag Logic Examples:
          # 1. On tag push (e.g. v3.7.4-20250125):
          #    - ghcr.io/mountaintopsolutions/apt-cacher-ng:3.7.4-20250125
          #    - ghcr.io/mountaintopsolutions/apt-cacher-ng:latest
          #
          # 2. On other branches/PRs:
          #    - ghcr.io/mountaintopsolutions/apt-cacher-ng:sha-123456

      - name: Set up Docker Buildx
        id: buildx
        uses: docker/setup-buildx-action@v3

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
        with:
          platforms: 'linux/amd64,linux/arm64,linux/arm/v7'

      - name: Login to Github Packages
        if: github.event_name != 'pull_request'
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Build image and push to container registries
        uses: docker/build-push-action@v6
        with:
          context: .
          push: ${{ github.event_name != 'pull_request' }}
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
          platforms: linux/amd64,linux/arm64/v8,linux/arm/v7

      - name: Image digest
        run: echo ${{ steps.docker_build.outputs.digest }}
